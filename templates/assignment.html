{% extends "base.html" %}

{% block content %}
<div class="content-header">
    <h2>2단계: 상세 호실 배정 관리</h2>
    <p>선발된 학생들을 실제 방 호수에 매칭하고 룸메이트를 지정합니다.</p>
</div>

<div class="card">
    <h3 style="margin-top: 0;"><i class="fas fa-file-import"></i> 데이터 업로드 (2단계 전용)</h3>
    <p style="font-size: 0.85rem; color: #888;">* 배정할 학생 명단과 방 호수 정보를 각각 업로드하세요.</p>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">1. 배정 대상 학생 명단</label>
            <div class="dropzone" id="stuDropzone" onclick="document.getElementById('stuFile').click()">
                <i class="fa-solid fa-upload fa-2x"></i>
                <p id="stuFileName">파일을 클릭하거나 여기에 드래그하세요</p>
                <input type="file" id="stuFile" style="display:none;"
                       onchange="updateFileName(this, 'stuFileName')">
            </div>
        </div>

        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">2. 기숙사 방 정보</label>
            <div class="dropzone" id="roomDropzone" onclick="document.getElementById('roomFile').click()">
                <i class="fa-solid fa-upload fa-2x"></i>
                <p id="roomFileName">파일을 클릭하거나 여기에 드래그하세요</p>
                <input type="file" id="roomFile" style="display:none;"
                       onchange="updateFileName(this, 'roomFileName')">
            </div>
        </div>
    </div>

    <button class="btn btn-primary" onclick="uploadAllAssignmentData()">
        배정용 데이터 업로드
    </button>
</div>

<div class="card">
    <h3><i class="fas fa-magic"></i> 알고리즘 실행</h3>
    <button class="btn btn-gold" onclick="runRoomMatching()">
        <i class="fas fa-play" style="margin-right: 8px;"></i> 자동 호실 배정 시작
    </button>
    <div id="status-bar" style="margin-top: 15px; font-weight: bold; color: var(--dmu-blue);"></div>
    <div id="result-area" style="display:none; margin-top: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>최종 배정 결과</h3>
            <button onclick="downloadAssignmentExcel()" class="btn-download">
                <i class="fas fa-file-excel"></i> 배정 결과 다운로드
            </button>
        </div>
        <table class="table">
            <thead>
            <tr>
                <th>학번</th>
                <th>성명</th>
                <th>성별</th>
                <th>배정 방</th>
                <th>사유</th>
            </tr>
            </thead>
            <tbody id="result-body"></tbody>
        </table>
    </div>
</div>

<script>
    // [추가] 방 정보 업로드 함수
    async function uploadAllAssignmentData() {
        const stu = document.getElementById('stuFile').files[0];
        const room = document.getElementById('roomFile').files[0];

        if (!stu || !room) {
            alert("학생 명단과 방 정보를 모두 선택해주세요.");
            return;
        }

        const formData = new FormData();
        formData.append('students', stu);
        formData.append('rooms', room);

        try {
            const resp = await fetch('/assignment/upload-assignment-data', {method: 'POST', body: formData});
            const res = await resp.json();
            alert(res.message);
        } catch (e) {
            alert("업로드 중 오류가 발생했습니다.");
        }
    }

    async function runRoomMatching() {
        const btn = event.target;
        const body = document.getElementById('result-body');
        const area = document.getElementById('result-area');
        const statusBar = document.getElementById('status-bar');

        btn.disabled = true;
        btn.innerText = "배정 중...";
        statusBar.innerText = "서버에서 배정 데이터를 가져오는 중입니다...";

        try {
            const resp = await fetch('/assignment/run-room-matching', {method: 'POST'});

            // 브라우저 로그 1: HTTP 상태 코드 확인
            console.log("HTTP 응답 상태:", resp.status);

            const res = await resp.json();

            // 브라우저 로그 2: 서버가 보낸 실제 데이터 구조 확인
            console.log("서버 응답 데이터:", res);

            if (res.status === "success" && res.data) {
                body.innerHTML = "";

                if (res.data.length === 0) {
                    statusBar.innerText = "배정된 인원이 없습니다. 데이터를 확인하세요.";
                    return;
                }

                res.data.forEach((item, index) => {
                    // 브라우저 로그 3: 개별 아이템의 키값 확인 (오타 방지용)
                    if (index === 0) console.log("첫 번째 데이터 샘플:", item);

                    const row = `<tr>
                    <td>${item['학번'] || '-'}</td>
                    <td>${item['성명'] || '-'}</td>
                    <td>${item['성별'] || '-'}</td>
                    <td>${item['기숙사 실'] || '-'}</td>
                    <td style="font-weight:bold; color:blue;">${item['방 번호'] || '미배정'}</td>
                    <td>${item['선정 이유'] || '-'}</td>
                </tr>`;
                    body.innerHTML += row;
                });

                area.style.display = 'block';
                statusBar.innerText = `총 ${res.data.length}명 배정 완료`;
                alert("호실 배정이 완료되었습니다.");
            } else {
                console.error("서버 로직 실패:", res.message);
                statusBar.innerText = "배정 실패: " + (res.message || "데이터를 확인하세요.");
            }
        } catch (e) {
            console.error("네트워크/자바스크립트 오류:", e);
            statusBar.innerText = "통신 중 오류가 발생했습니다. (F12 콘솔 확인)";
        } finally {
            btn.disabled = false;
            btn.innerText = "호실 배정 알고리즘 실행";
        }
    }

    function downloadAssignmentExcel() {
        window.location.href = "/assignment/download-assignment-results";
    }

    // 파일 선택 시 이름 업데이트
    function updateFileName(input, targetId) {
        const fileName = input.files[0] ? input.files[0].name : "파일을 클릭하거나 여기에 드래그하세요";
        document.getElementById(targetId).innerText = fileName;
    }

    // 드래그 앤 드롭 이벤트 처리
    ['stuDropzone', 'roomDropzone'].forEach(id => {
        const zone = document.getElementById(id);
        const input = zone.querySelector('input[type="file"]');

        // 드래그 효과
        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            zone.classList.add('dragover');
        });

        zone.addEventListener('dragleave', () => {
            zone.classList.remove('dragover');
        });

        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('dragover');

            if (e.dataTransfer.files.length > 0) {
                input.files = e.dataTransfer.files; // 파일 할당
                updateFileName(input, zone.querySelector('p').id);
            }
        });
    });
</script>
{% endblock %}